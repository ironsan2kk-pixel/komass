"""
Komas Trading Server - Preset Database Operations (v3)
======================================================
CRUD operations for indicator presets.

NEW in Chat #31-33:
- get_all_presets() - Get all presets without pagination
- delete_presets_by_ids() - Batch delete
- update_presets_by_ids() - Batch update
- get_preset_by_name() - Find by name

Features:
- Create, read, update, delete presets
- Filter by indicator type, category, source
- Search by name
- Bulk operations with progress tracking
- Migration utilities

Chat: #31-33 — Presets Full Module
"""
import json
import logging
import hashlib
from datetime import datetime
from typing import Optional, List, Dict, Any, Callable
from pathlib import Path

logger = logging.getLogger(__name__)

# Database path
DB_DIR = Path(__file__).parent.parent.parent.parent / "data"
DB_DIR.mkdir(exist_ok=True)

# Table name
TABLE_NAME = "presets"
OLD_TABLE_NAME = "dominant_presets"  # For migration


def _generate_preset_id(name: str, indicator_type: str, symbol: str = None, timeframe: str = None) -> str:
    """Generate unique preset ID based on name and params"""
    key = f"{indicator_type}:{name}:{symbol or 'ANY'}:{timeframe or 'ANY'}"
    hash_part = hashlib.md5(key.encode()).hexdigest()[:8]
    clean_name = name.replace(" ", "_").replace("/", "_").replace("|", "_")[:20]
    return f"{indicator_type.upper()}_{clean_name}_{hash_part}"


def _get_db_connection():
    """Get SQLite connection with proper settings"""
    import sqlite3
    db_path = DB_DIR / "komas.db"
    conn = sqlite3.connect(str(db_path))
    conn.row_factory = sqlite3.Row
    return conn


def ensure_presets_table():
    """Create presets table if not exists, migrate from old table if needed"""
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    # Check if new table exists
    cursor.execute(f"""
        SELECT name FROM sqlite_master 
        WHERE type='table' AND name='{TABLE_NAME}'
    """)
    
    new_table_exists = cursor.fetchone() is not None
    
    # Check if old table exists (for migration)
    cursor.execute(f"""
        SELECT name FROM sqlite_master 
        WHERE type='table' AND name='{OLD_TABLE_NAME}'
    """)
    old_table_exists = cursor.fetchone() is not None
    
    if not new_table_exists:
        logger.info(f"Creating {TABLE_NAME} table...")
        cursor.execute(f"""
            CREATE TABLE IF NOT EXISTS {TABLE_NAME} (
                id TEXT PRIMARY KEY,
                name TEXT NOT NULL,
                description TEXT,
                indicator_type TEXT NOT NULL DEFAULT 'dominant',
                category TEXT NOT NULL DEFAULT 'mid-term',
                symbol TEXT,
                timeframe TEXT,
                params JSON NOT NULL,
                source TEXT DEFAULT 'manual',
                is_active INTEGER DEFAULT 1,
                is_favorite INTEGER DEFAULT 0,
                tags TEXT,
                win_rate REAL,
                profit_factor REAL,
                total_profit_percent REAL,
                max_drawdown_percent REAL,
                sharpe_ratio REAL,
                total_trades INTEGER,
                avg_trade_percent REAL,
                universality_score REAL,
                created_at TEXT NOT NULL,
                updated_at TEXT NOT NULL
            )
        """)
        
        # Create indexes
        cursor.execute(f"CREATE INDEX IF NOT EXISTS idx_preset_indicator ON {TABLE_NAME}(indicator_type)")
        cursor.execute(f"CREATE INDEX IF NOT EXISTS idx_preset_category ON {TABLE_NAME}(category)")
        cursor.execute(f"CREATE INDEX IF NOT EXISTS idx_preset_source ON {TABLE_NAME}(source)")
        cursor.execute(f"CREATE INDEX IF NOT EXISTS idx_preset_symbol ON {TABLE_NAME}(symbol)")
        cursor.execute(f"CREATE INDEX IF NOT EXISTS idx_preset_name ON {TABLE_NAME}(name)")
        cursor.execute(f"CREATE UNIQUE INDEX IF NOT EXISTS idx_preset_name_unique ON {TABLE_NAME}(name)")
        
        conn.commit()
        logger.info(f"✓ {TABLE_NAME} table created")
        
        # Migrate from old table if exists
        if old_table_exists:
            logger.info(f"Migrating from {OLD_TABLE_NAME}...")
            _migrate_from_old_table(cursor)
            conn.commit()
    
    conn.close()


def _migrate_from_old_table(cursor):
    """Migrate data from old dominant_presets table"""
    try:
        cursor.execute(f"SELECT * FROM {OLD_TABLE_NAME}")
        rows = cursor.fetchall()
        
        migrated = 0
        for row in rows:
            row_dict = dict(row)
            
            # Map old columns to new
            cursor.execute(f"""
                INSERT OR IGNORE INTO {TABLE_NAME} 
                (id, name, description, indicator_type, category, params, source, 
                 is_active, is_favorite, tags, created_at, updated_at)
                VALUES (?, ?, ?, 'dominant', ?, ?, ?, ?, ?, ?, ?, ?)
            """, (
                row_dict.get("id"),
                row_dict.get("name"),
                row_dict.get("description"),
                row_dict.get("category", "mid-term"),
                row_dict.get("params", "{}"),
                row_dict.get("source", "manual"),
                row_dict.get("is_active", 1),
                row_dict.get("is_favorite", 0),
                row_dict.get("tags"),
                row_dict.get("created_at", datetime.utcnow().isoformat()),
                row_dict.get("updated_at", datetime.utcnow().isoformat())
            ))
            migrated += 1
        
        logger.info(f"✓ Migrated {migrated} presets from {OLD_TABLE_NAME}")
    except Exception as e:
        logger.error(f"Migration error: {e}")


def create_preset(
    name: str,
    indicator_type: str,
    params: Dict[str, Any],
    category: str = "mid-term",
    description: str = None,
    symbol: str = None,
    timeframe: str = None,
    source: str = "manual",
    tags: List[str] = None
) -> Dict[str, Any]:
    """Create a new preset"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    # Generate ID
    preset_id = _generate_preset_id(name, indicator_type, symbol, timeframe)
    
    # Check if name already exists
    cursor.execute(f"SELECT id FROM {TABLE_NAME} WHERE name = ?", (name,))
    if cursor.fetchone():
        conn.close()
        raise ValueError(f"Preset with name '{name}' already exists")
    
    now = datetime.utcnow().isoformat()
    
    cursor.execute(f"""
        INSERT INTO {TABLE_NAME} 
        (id, name, description, indicator_type, category, symbol, timeframe, 
         params, source, tags, is_active, is_favorite, created_at, updated_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 1, 0, ?, ?)
    """, (
        preset_id,
        name,
        description,
        indicator_type,
        category,
        symbol,
        timeframe,
        json.dumps(params),
        source,
        json.dumps(tags) if tags else None,
        now,
        now
    ))
    
    conn.commit()
    
    # Return created preset
    cursor.execute(f"SELECT * FROM {TABLE_NAME} WHERE id = ?", (preset_id,))
    row = cursor.fetchone()
    conn.close()
    
    return _row_to_dict(row)


def get_preset(preset_id: str) -> Optional[Dict[str, Any]]:
    """Get a single preset by ID"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    cursor.execute(f"SELECT * FROM {TABLE_NAME} WHERE id = ?", (preset_id,))
    row = cursor.fetchone()
    conn.close()
    
    return _row_to_dict(row) if row else None


def get_preset_by_name(name: str) -> Optional[Dict[str, Any]]:
    """Get a single preset by name"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    cursor.execute(f"SELECT * FROM {TABLE_NAME} WHERE name = ?", (name,))
    row = cursor.fetchone()
    conn.close()
    
    return _row_to_dict(row) if row else None


def list_presets(
    indicator_type: str = None,
    category: str = None,
    source: str = None,
    symbol: str = None,
    timeframe: str = None,
    is_active: bool = None,
    is_favorite: bool = None,
    search: str = None,
    limit: int = None,
    offset: int = 0
) -> List[Dict[str, Any]]:
    """List presets with optional filters"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    # Build query
    query = f"SELECT * FROM {TABLE_NAME} WHERE 1=1"
    params = []
    
    if indicator_type:
        query += " AND indicator_type = ?"
        params.append(indicator_type)
    
    if category:
        query += " AND category = ?"
        params.append(category)
    
    if source:
        query += " AND source = ?"
        params.append(source)
    
    if symbol:
        query += " AND symbol = ?"
        params.append(symbol)
    
    if timeframe:
        query += " AND timeframe = ?"
        params.append(timeframe)
    
    if is_active is not None:
        query += " AND is_active = ?"
        params.append(1 if is_active else 0)
    
    if is_favorite is not None:
        query += " AND is_favorite = ?"
        params.append(1 if is_favorite else 0)
    
    if search:
        query += " AND (name LIKE ? OR description LIKE ?)"
        search_term = f"%{search}%"
        params.extend([search_term, search_term])
    
    query += " ORDER BY is_favorite DESC, name ASC"
    
    if limit:
        query += f" LIMIT {limit} OFFSET {offset}"
    
    cursor.execute(query, params)
    rows = cursor.fetchall()
    conn.close()
    
    return [_row_to_dict(row) for row in rows]


def get_all_presets(
    indicator_type: str = None,
    source: str = None
) -> List[Dict[str, Any]]:
    """Get all presets without pagination (for backup)"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    query = f"SELECT * FROM {TABLE_NAME} WHERE 1=1"
    params = []
    
    if indicator_type:
        query += " AND indicator_type = ?"
        params.append(indicator_type)
    
    if source:
        query += " AND source = ?"
        params.append(source)
    
    query += " ORDER BY name ASC"
    
    cursor.execute(query, params)
    rows = cursor.fetchall()
    conn.close()
    
    return [_row_to_dict(row) for row in rows]


def count_presets(
    indicator_type: str = None,
    category: str = None,
    source: str = None,
    is_active: bool = None
) -> int:
    """Count presets with optional filters"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    query = f"SELECT COUNT(*) FROM {TABLE_NAME} WHERE 1=1"
    params = []
    
    if indicator_type:
        query += " AND indicator_type = ?"
        params.append(indicator_type)
    
    if category:
        query += " AND category = ?"
        params.append(category)
    
    if source:
        query += " AND source = ?"
        params.append(source)
    
    if is_active is not None:
        query += " AND is_active = ?"
        params.append(1 if is_active else 0)
    
    cursor.execute(query, params)
    count = cursor.fetchone()[0]
    conn.close()
    
    return count


def update_preset(preset_id: str, **kwargs) -> Optional[Dict[str, Any]]:
    """Update a preset"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    # Check exists
    cursor.execute(f"SELECT id FROM {TABLE_NAME} WHERE id = ?", (preset_id,))
    if not cursor.fetchone():
        conn.close()
        return None
    
    # Build update query
    allowed_fields = {
        "name", "description", "category", "symbol", "timeframe",
        "params", "is_active", "is_favorite", "tags",
        "win_rate", "profit_factor", "total_profit_percent",
        "max_drawdown_percent", "sharpe_ratio"
    }
    
    updates = []
    params = []
    
    for key, value in kwargs.items():
        if key in allowed_fields:
            if key == "params":
                value = json.dumps(value)
            elif key == "tags":
                value = json.dumps(value) if value else None
            elif key in ("is_active", "is_favorite"):
                value = 1 if value else 0
            
            updates.append(f"{key} = ?")
            params.append(value)
    
    if not updates:
        conn.close()
        return get_preset(preset_id)
    
    updates.append("updated_at = ?")
    params.append(datetime.utcnow().isoformat())
    params.append(preset_id)
    
    query = f"UPDATE {TABLE_NAME} SET {', '.join(updates)} WHERE id = ?"
    cursor.execute(query, params)
    conn.commit()
    
    # Return updated preset
    cursor.execute(f"SELECT * FROM {TABLE_NAME} WHERE id = ?", (preset_id,))
    row = cursor.fetchone()
    conn.close()
    
    return _row_to_dict(row)


def delete_preset(preset_id: str) -> bool:
    """Delete a preset"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    cursor.execute(f"DELETE FROM {TABLE_NAME} WHERE id = ?", (preset_id,))
    deleted = cursor.rowcount > 0
    conn.commit()
    conn.close()
    
    return deleted


def delete_presets_by_source(source: str) -> int:
    """Delete all presets by source"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    cursor.execute(f"DELETE FROM {TABLE_NAME} WHERE source = ?", (source,))
    deleted = cursor.rowcount
    conn.commit()
    conn.close()
    
    return deleted


def delete_presets_by_ids(preset_ids: List[str]) -> int:
    """Delete multiple presets by IDs"""
    ensure_presets_table()
    
    if not preset_ids:
        return 0
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    placeholders = ','.join('?' * len(preset_ids))
    cursor.execute(f"DELETE FROM {TABLE_NAME} WHERE id IN ({placeholders})", preset_ids)
    deleted = cursor.rowcount
    conn.commit()
    conn.close()
    
    return deleted


def update_presets_by_ids(preset_ids: List[str], updates: Dict[str, Any]) -> int:
    """Update multiple presets by IDs"""
    ensure_presets_table()
    
    if not preset_ids or not updates:
        return 0
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    # Build update query
    allowed_fields = {"category", "is_active", "is_favorite", "tags"}
    
    set_clauses = []
    params = []
    
    for key, value in updates.items():
        if key in allowed_fields:
            if key == "tags":
                value = json.dumps(value) if value else None
            elif key in ("is_active", "is_favorite"):
                value = 1 if value else 0
            
            set_clauses.append(f"{key} = ?")
            params.append(value)
    
    if not set_clauses:
        conn.close()
        return 0
    
    set_clauses.append("updated_at = ?")
    params.append(datetime.utcnow().isoformat())
    
    placeholders = ','.join('?' * len(preset_ids))
    params.extend(preset_ids)
    
    query = f"UPDATE {TABLE_NAME} SET {', '.join(set_clauses)} WHERE id IN ({placeholders})"
    cursor.execute(query, params)
    updated = cursor.rowcount
    conn.commit()
    conn.close()
    
    return updated


def bulk_create_presets(
    presets: List[Dict[str, Any]],
    on_progress: Callable[[int, int], None] = None
) -> Dict[str, int]:
    """Bulk create presets with progress callback"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    created = 0
    skipped = 0
    errors = 0
    total = len(presets)
    
    for i, preset_data in enumerate(presets):
        try:
            name = preset_data["name"]
            indicator_type = preset_data.get("indicator_type", "dominant")
            
            # Check if exists
            cursor.execute(f"SELECT id FROM {TABLE_NAME} WHERE name = ?", (name,))
            if cursor.fetchone():
                skipped += 1
                continue
            
            preset_id = _generate_preset_id(
                name, 
                indicator_type,
                preset_data.get("symbol"),
                preset_data.get("timeframe")
            )
            
            now = datetime.utcnow().isoformat()
            
            cursor.execute(f"""
                INSERT INTO {TABLE_NAME} 
                (id, name, description, indicator_type, category, symbol, timeframe, 
                 params, source, tags, is_active, is_favorite, created_at, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 1, 0, ?, ?)
            """, (
                preset_id,
                name,
                preset_data.get("description"),
                indicator_type,
                preset_data.get("category", "mid-term"),
                preset_data.get("symbol"),
                preset_data.get("timeframe"),
                json.dumps(preset_data.get("params", {})),
                preset_data.get("source", "manual"),
                json.dumps(preset_data.get("tags")) if preset_data.get("tags") else None,
                now,
                now
            ))
            created += 1
            
        except Exception as e:
            logger.error(f"Error creating preset {preset_data.get('name')}: {e}")
            errors += 1
        
        if on_progress and (i + 1) % 10 == 0:
            on_progress(i + 1, total)
    
    conn.commit()
    conn.close()
    
    return {"created": created, "skipped": skipped, "errors": errors}


def get_preset_stats() -> Dict[str, Any]:
    """Get preset statistics"""
    ensure_presets_table()
    
    conn = _get_db_connection()
    cursor = conn.cursor()
    
    stats = {
        "total_presets": 0,
        "by_indicator": {},
        "by_category": {},
        "by_source": {},
        "active": 0,
        "favorites": 0
    }
    
    # Total
    cursor.execute(f"SELECT COUNT(*) FROM {TABLE_NAME}")
    stats["total_presets"] = cursor.fetchone()[0]
    
    # By indicator
    cursor.execute(f"SELECT indicator_type, COUNT(*) FROM {TABLE_NAME} GROUP BY indicator_type")
    for row in cursor.fetchall():
        stats["by_indicator"][row[0] or "unknown"] = row[1]
    
    # By category
    cursor.execute(f"SELECT category, COUNT(*) FROM {TABLE_NAME} GROUP BY category")
    for row in cursor.fetchall():
        stats["by_category"][row[0] or "unknown"] = row[1]
    
    # By source
    cursor.execute(f"SELECT source, COUNT(*) FROM {TABLE_NAME} GROUP BY source")
    for row in cursor.fetchall():
        stats["by_source"][row[0] or "unknown"] = row[1]
    
    # Active
    cursor.execute(f"SELECT COUNT(*) FROM {TABLE_NAME} WHERE is_active = 1")
    stats["active"] = cursor.fetchone()[0]
    
    # Favorites
    cursor.execute(f"SELECT COUNT(*) FROM {TABLE_NAME} WHERE is_favorite = 1")
    stats["favorites"] = cursor.fetchone()[0]
    
    conn.close()
    
    return stats


def _row_to_dict(row) -> Dict[str, Any]:
    """Convert SQLite row to dict"""
    if not row:
        return None
    
    d = dict(row)
    
    # Parse JSON fields
    if d.get("params"):
        try:
            d["params"] = json.loads(d["params"])
        except:
            d["params"] = {}
    
    if d.get("tags"):
        try:
            d["tags"] = json.loads(d["tags"])
        except:
            d["tags"] = []
    
    # Convert booleans
    d["is_active"] = bool(d.get("is_active", 1))
    d["is_favorite"] = bool(d.get("is_favorite", 0))
    
    return d


__all__ = [
    "ensure_presets_table",
    "create_preset",
    "get_preset",
    "get_preset_by_name",
    "list_presets",
    "get_all_presets",
    "count_presets",
    "update_preset",
    "delete_preset",
    "delete_presets_by_source",
    "delete_presets_by_ids",
    "update_presets_by_ids",
    "bulk_create_presets",
    "get_preset_stats",
]
